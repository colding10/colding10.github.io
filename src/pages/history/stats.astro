---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import {
	getTierBadgeClasses,
	getTierFromRank,
	parsePlacementNumber,
} from '@/lib/history-utils'
import { Icon } from 'astro-icon/components'
import { getCollection } from 'astro:content'

const ctfCollection = await getCollection('ctfs')
const entries = ctfCollection.map((entry) => ({ id: entry.id, ...entry.data }))

// Calculate statistics
const totalCTFs = entries.length
const uniqueMonths = new Set(entries.map((e) => `${e.year}-${e.month}`)).size
const uniqueYears = new Set(entries.map((e) => e.year)).size

// Overall statistics
const placements = entries
	.map((e) => parsePlacementNumber(e.placement))
	.filter((p): p is number => p !== null)
const averagePlacement =
	placements.length > 0
		? Math.round(placements.reduce((a, b) => a + b, 0) / placements.length)
		: 0
const bestPlacement = placements.length > 0 ? Math.min(...placements) : 0
const worstPlacement = placements.length > 0 ? Math.max(...placements) : 0

// Tier distribution
const tierCounts = entries.reduce(
	(acc, e) => {
		const rank = parsePlacementNumber(e.placement)
		if (rank) {
			const tier = getTierFromRank(rank)
			acc[tier] = (acc[tier] || 0) + 1
		}
		return acc
	},
	{} as Record<string, number>,
)

// Team statistics
const teamStats = entries.reduce(
	(acc, e) => {
		if (e.team) {
			if (!acc[e.team]) {
				acc[e.team] = { count: 0, placements: [], averagePlacement: 0 }
			}
			acc[e.team].count++
			const rank = parsePlacementNumber(e.placement)
			if (rank) {
				acc[e.team].placements.push(rank)
			}
		}
		return acc
	},
	{} as Record<
		string,
		{ count: number; placements: number[]; averagePlacement: number }
	>,
)

// Calculate average placement per team
Object.keys(teamStats).forEach((team) => {
	const placements = teamStats[team].placements
	teamStats[team].averagePlacement =
		placements.length > 0
			? Math.round(
					placements.reduce((a, b) => a + b, 0) / placements.length,
				)
			: 0
})

// Monthly statistics
const monthlyStats = entries.reduce(
	(acc, e) => {
		const key = `${e.year}-${String(e.month).padStart(2, '0')}`
		if (!acc[key]) {
			acc[key] = {
				year: e.year,
				month: e.month,
				count: 0,
				placements: [],
				teams: new Set(),
				teamCount: 0,
				averagePlacement: 0,
				bestPlacement: 0,
			}
		}
		acc[key].count++
		const rank = parsePlacementNumber(e.placement)
		if (rank) {
			acc[key].placements.push(rank)
		}
		if (e.team) {
			acc[key].teams.add(e.team)
		}
		return acc
	},
	{} as Record<
		string,
		{
			year: number
			month: number
			count: number
			placements: number[]
			teams: Set<string>
			teamCount: number
			averagePlacement: number
			bestPlacement: number
		}
	>,
)

// Convert teams Set to count and calculate averages
Object.keys(monthlyStats).forEach((key) => {
	const month = monthlyStats[key]
	month.teamCount = month.teams.size
	month.averagePlacement =
		month.placements.length > 0
			? Math.round(
					month.placements.reduce((a, b) => a + b, 0) /
						month.placements.length,
				)
			: 0
	month.bestPlacement =
		month.placements.length > 0 ? Math.min(...month.placements) : 0
})

// Sort monthly stats by date
const sortedMonthlyStats = Object.values(monthlyStats).sort(
	(a, b) => b.year - a.year || b.month - a.month,
)

// Yearly statistics
const yearlyStats = entries.reduce(
	(acc, e) => {
		if (!acc[e.year]) {
			acc[e.year] = {
				year: e.year,
				count: 0,
				placements: [],
				teams: new Set(),
				teamCount: 0,
				averagePlacement: 0,
				bestPlacement: 0,
			}
		}
		acc[e.year].count++
		const rank = parsePlacementNumber(e.placement)
		if (rank) {
			acc[e.year].placements.push(rank)
		}
		if (e.team) {
			acc[e.year].teams.add(e.team)
		}
		return acc
	},
	{} as Record<
		number,
		{
			year: number
			count: number
			placements: number[]
			teams: Set<string>
			teamCount: number
			averagePlacement: number
			bestPlacement: number
		}
	>,
)

// Calculate yearly averages
Object.keys(yearlyStats).forEach((year) => {
	const yearData = yearlyStats[parseInt(year)]
	yearData.teamCount = yearData.teams.size
	yearData.averagePlacement =
		yearData.placements.length > 0
			? Math.round(
					yearData.placements.reduce((a, b) => a + b, 0) /
						yearData.placements.length,
				)
			: 0
	yearData.bestPlacement =
		yearData.placements.length > 0 ? Math.min(...yearData.placements) : 0
})

const sortedYearlyStats = Object.values(yearlyStats).sort(
	(a, b) => b.year - a.year,
)

// Top performing months
const topMonths = sortedMonthlyStats
	.filter((m) => m.placements.length > 0)
	.sort((a, b) => a.averagePlacement - b.averagePlacement)
	.slice(0, 5)

// Most active months
const mostActiveMonths = sortedMonthlyStats
	.sort((a, b) => b.count - a.count)
	.slice(0, 5)

const MONTHS = [
	'Jan',
	'Feb',
	'Mar',
	'Apr',
	'May',
	'Jun',
	'Jul',
	'Aug',
	'Sep',
	'Oct',
	'Nov',
	'Dec',
]
---

<Layout class="max-w-3xl overflow-x-hidden">
	<PageHead
		slot="head"
		title="CTF Statistics"
		description="Statistics and analytics for CTF performance over time"
	/>
	<Breadcrumbs
		items={[
			{ href: '/history', label: 'History', icon: 'lucide:calendar' },
			{ label: 'Statistics', icon: 'lucide:bar-chart-3' },
		]}
	/>

	<section class="font-mono">
		<h1 class="mt-5 text-3xl font-bold">CTF Statistics</h1>
		<p class="text-muted-foreground mt-2">
			Performance analytics and trends over time.
		</p>

		<div class="mt-8 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
			<div class="rounded-lg border bg-secondary/50 p-5">
				<div class="flex items-center gap-3">
					<div class="bg-muted rounded-lg p-2.5">
						<Icon name="lucide:trophy" class="text-muted-foreground h-5 w-5" />
					</div>
					<div>
						<div class="text-2xl font-bold">{totalCTFs}</div>
						<div class="text-muted-foreground text-sm">Total CTFs</div>
					</div>
				</div>
			</div>

			<div class="rounded-lg border bg-secondary/50 p-5">
				<div class="flex items-center gap-3">
					<div class="bg-muted rounded-lg p-2.5">
						<Icon name="lucide:target" class="text-muted-foreground h-5 w-5" />
					</div>
					<div>
						<div class="text-2xl font-bold">#{averagePlacement}</div>
						<div class="text-muted-foreground text-sm">Avg Placement</div>
					</div>
				</div>
			</div>

			<div class="rounded-lg border bg-secondary/50 p-5">
				<div class="flex items-center gap-3">
					<div class="bg-muted rounded-lg p-2.5">
						<Icon name="lucide:crown" class="text-muted-foreground h-5 w-5" />
					</div>
					<div>
						<div class="text-2xl font-bold">#{bestPlacement}</div>
						<div class="text-muted-foreground text-sm">Best Placement</div>
					</div>
				</div>
			</div>

			<div class="rounded-lg border bg-secondary/50 p-5">
				<div class="flex items-center gap-3">
					<div class="bg-muted rounded-lg p-2.5">
						<Icon name="lucide:calendar" class="text-muted-foreground h-5 w-5" />
					</div>
					<div>
						<div class="text-2xl font-bold">{uniqueMonths}</div>
						<div class="text-muted-foreground text-sm">Active Months</div>
					</div>
				</div>
			</div>
		</div>

		<div class="mt-8">
			<h2 class="mb-4 text-2xl font-bold">Tier Distribution</h2>
			<div class="space-y-2">
				{
					Object.entries(tierCounts)
						.sort(([a], [b]) => {
							const tierOrder = { SS: 0, S: 1, A: 2, B: 3, C: 4, D: 5, F: 6 }
							return (
								(tierOrder[a as keyof typeof tierOrder] ?? 999) -
								(tierOrder[b as keyof typeof tierOrder] ?? 999)
							)
						})
						.map(([tier, count]) => {
							const percentage = Math.round((count / totalCTFs) * 100)
							return (
								<div class="flex items-center gap-3 rounded-lg border p-3">
									<span
										class={`inline-flex h-7 w-7 items-center justify-center rounded-full text-xs font-bold ${getTierBadgeClasses(tier as any)}`}
									>
										{tier}
									</span>
									<span class="w-16 font-medium">{tier} Tier</span>
									<div class="flex-1">
										<div class="bg-muted h-2 w-full overflow-hidden rounded-full">
											<div
												class="bg-primary h-full rounded-full transition-all duration-500"
												style={`width: ${percentage}%`}
											/>
										</div>
									</div>
									<span class="text-muted-foreground w-8 text-right text-sm">
										{count}
									</span>
									<span class="text-muted-foreground w-10 text-right text-sm">
										{percentage}%
									</span>
								</div>
							)
						})
				}
			</div>
		</div>

		<!-- Team Statistics -->
		<div class="mt-8">
			<h2 class="mb-4 text-2xl font-bold">Team Performance</h2>
			<div class="divide-y rounded-lg border">
				{
					Object.entries(teamStats)
						.sort((a, b) => b[1].count - a[1].count)
						.map(([team, stats], index) => (
							<div class="flex items-center gap-4 p-4">
								<span class="text-muted-foreground w-6 text-right text-sm font-medium">
									{index + 1}
								</span>
								<div class="min-w-0 flex-1">
									<div class="font-medium">{team}</div>
									<div class="text-muted-foreground text-sm">
										{stats.count} CTF{stats.count !== 1 ? 's' : ''}
									</div>
								</div>
								<div class="text-right">
									<div class="font-medium">#{stats.averagePlacement}</div>
									<div class="text-muted-foreground text-xs">avg</div>
								</div>
								<div class="text-right">
									<div class="font-medium">
										#{Math.min(...stats.placements)}
									</div>
									<div class="text-muted-foreground text-xs">best</div>
								</div>
							</div>
						))
				}
			</div>
		</div>

		<!-- Top Performing & Most Active Months -->
		<div class="mt-8 grid gap-6 md:grid-cols-2">
			<div class="rounded-lg border p-5">
				<h2 class="mb-4 text-lg font-bold">Top Performing Months</h2>
				<div class="space-y-3">
					{
						topMonths.map((month, index) => (
							<div class="flex items-center gap-3">
								<span class="text-muted-foreground w-5 text-sm">
									{index + 1}
								</span>
								<div class="flex-1">
									<span class="font-medium">
										{MONTHS[month.month - 1]} {month.year}
									</span>
									<span class="text-muted-foreground ml-2 text-sm">
										{month.count} CTF{month.count !== 1 ? 's' : ''}
									</span>
								</div>
								<span class="font-medium">#{month.averagePlacement}</span>
							</div>
						))
					}
				</div>
			</div>

			<div class="rounded-lg border p-5">
				<h2 class="mb-4 text-lg font-bold">Most Active Months</h2>
				<div class="space-y-3">
					{
						mostActiveMonths.map((month, index) => (
							<div class="flex items-center gap-3">
								<span class="text-muted-foreground w-5 text-sm">
									{index + 1}
								</span>
								<div class="flex-1">
									<span class="font-medium">
										{MONTHS[month.month - 1]} {month.year}
									</span>
									<span class="text-muted-foreground ml-2 text-sm">
										#{month.averagePlacement} avg
									</span>
								</div>
								<span class="font-medium">
									{month.count} CTF{month.count !== 1 ? 's' : ''}
								</span>
							</div>
						))
					}
				</div>
			</div>
		</div>

		<!-- Yearly Overview -->
		<div class="mt-8">
			<h2 class="mb-4 text-2xl font-bold">Yearly Overview</h2>
			<div class="overflow-hidden rounded-lg border">
				<div class="overflow-x-auto">
					<table class="w-full">
						<thead class="bg-muted/50">
							<tr>
								<th class="p-4 text-left font-medium">Year</th>
								<th class="p-4 text-left font-medium">CTFs</th>
								<th class="p-4 text-left font-medium">Teams</th>
								<th class="p-4 text-left font-medium"
									>Avg Placement</th
								>
								<th class="p-4 text-left font-medium">Best</th>
							</tr>
						</thead>
						<tbody>
							{
								sortedYearlyStats.map((year) => (
									<tr class="border-t">
										<td class="p-4 font-medium">
											{year.year}
										</td>
										<td class="p-4">{year.count}</td>
										<td class="p-4">{year.teamCount}</td>
										<td class="p-4">
											{year.averagePlacement}
										</td>
										<td class="p-4">
											{year.bestPlacement}
										</td>
									</tr>
								))
							}
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Recent Activity -->
		<div class="mt-8">
			<h2 class="mb-4 text-2xl font-bold">Recent Activity</h2>
			<div class="space-y-3">
				{
					sortedMonthlyStats.slice(0, 6).map((month) => (
						<div class="flex items-center justify-between rounded-lg border p-4">
							<div>
								<div class="font-medium">
									{MONTHS[month.month - 1]} {month.year}
								</div>
								<div class="text-muted-foreground text-sm">
									{month.count} CTF
									{month.count !== 1 ? 's' : ''} â€¢{' '}
									{month.teamCount} team
									{month.teamCount !== 1 ? 's' : ''}
								</div>
							</div>
							<div class="text-right">
								<div class="font-semibold">
									#{month.averagePlacement}
								</div>
								<div class="text-muted-foreground text-sm">
									avg placement
								</div>
							</div>
						</div>
					))
				}
			</div>
		</div>
	</section>
</Layout>
