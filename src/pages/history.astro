---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import { getCollection } from 'astro:content'

const MONTHS = [
  'January',
  'February',
  'March',
  'April',
  'May',
  'June',
  'July',
  'August',
  'September',
  'October',
  'November',
  'December',
]

// Get all CTF entries from the content collection
const ctfCollection = await getCollection('ctfs')
const entries = ctfCollection.map((entry) => entry.data)

// Sort newest first
const sorted = [...entries].sort((a, b) => b.year - a.year || b.month - a.month)

// Group by month-year for monthly markers on the timeline
type Group = { year: number; month: number; items: typeof entries }

const groupsMap = new Map<string, Group>()
for (const e of sorted) {
  const key = `${e.year}-${String(e.month).padStart(2, '0')}`
  if (!groupsMap.has(key))
    groupsMap.set(key, { year: e.year, month: e.month, items: [] })
  groupsMap.get(key)!.items.push(e)
}
const groups = Array.from(groupsMap.values()).sort(
  (a, b) => b.year - a.year || b.month - a.month,
)

// Calculate statistics
const totalCTFs = entries.length
const uniqueMonthsSet = new Set(entries.map((e) => `${e.year}-${e.month}`))
const totalMonths = uniqueMonthsSet.size
---

<Layout class="max-w-3xl">
  <PageHead
    slot="head"
    title="CTF History"
    description="Timeline of CTF competitions and results"
  />
  <Breadcrumbs items={[{ label: 'History', icon: 'lucide:calendar' }]} />

  <section aria-labelledby="ctf-history-title" class="font-mono">
    <h1 id="ctf-history-title" class="mt-5 text-3xl font-bold">CTF History</h1>
    <p class="text-muted-foreground mt-2">
      Competition results over time, newest first.
    </p>

    <!-- Statistics -->
    <div class="bg-secondary/30 mt-4 rounded-lg border p-4">
      <div class="flex flex-wrap gap-6 text-sm">
        <div>
          <span class="text-muted-foreground">Total CTFs:</span>
          <span class="ml-1 font-semibold">{totalCTFs}</span>
        </div>
        <div>
          <span class="text-muted-foreground">Months Active:</span>
          <span class="ml-1 font-semibold">{totalMonths}</span>
        </div>
      </div>
    </div>

    <!-- Disclaimer and Teams -->
    <div
      class="mt-4 rounded-lg border border-yellow-200 bg-yellow-50 p-4 dark:border-yellow-800 dark:bg-yellow-950/20"
    >
      <h2
        class="mb-2 text-sm font-semibold text-yellow-800 dark:text-yellow-200"
      >
        üìù Note
      </h2>
      <div class="space-y-2 text-xs text-yellow-700 dark:text-yellow-300">
        <p>
          <strong>Sorting:</strong> CTFs are sorted by month/year, but probably not
          within each month.
        </p>
        <p>
          <strong>Teams:</strong>
          <a
            href="https://ctftime.org/team/283028"
            target="_blank"
            rel="noopener noreferrer"
            class="font-mono hover:underline">BCA</a
          >,
          <a
            href="https://ctftime.org/team/222966"
            target="_blank"
            rel="noopener noreferrer"
            class="font-mono hover:underline">SPL</a
          >,
          <a
            href="https://ctftime.org/team/372043"
            target="_blank"
            rel="noopener noreferrer"
            class="font-mono hover:underline">CBF</a
          >,
          <a
            href="https://ctftime.org/team/396585"
            target="_blank"
            rel="noopener noreferrer"
            class="font-mono hover:underline">Cosmic Squid</a
          >,
          <a
            href="https://ctftime.org/team/375355"
            target="_blank"
            rel="noopener noreferrer"
            class="font-mono hover:underline"
            >[:]
          </a>
        </p>
      </div>
    </div>

    <div class="relative mt-8">
      <div class="bg-border absolute top-0 bottom-0 left-4 w-px"></div>

      <div class="space-y-10">
        {
          groups.map((group) => (
            <div>
              <div class="relative pl-10">
                <div class="bg-primary ring-background absolute top-2 left-4 h-3 w-3 rounded-full ring-2" />
                <p class="text-muted-foreground text-xs tracking-wider uppercase">
                  {MONTHS[group.month - 1]} {group.year}
                </p>
              </div>

              <ul class="mt-4 space-y-3">
                {group.items.map((e) => (
                  <li class="relative pl-10">
                    <div class="bg-accent ring-background absolute top-2 left-4 h-2 w-2 rounded-full ring-2" />
                    <div class="flex flex-wrap items-baseline gap-x-3 gap-y-1">
                      <a
                        href={e.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-primary font-medium hover:underline"
                      >
                        {e.name}
                      </a>

                      <span class="text-muted-foreground text-sm font-medium">
                        {e.placement}
                      </span>

                      {e.team && (
                        <span class="bg-secondary text-secondary-foreground rounded px-1.5 py-0.5 text-xs font-medium">
                          {e.team}
                        </span>
                      )}

                      {e.description && (
                        <span class="text-muted-foreground flex-shrink-0 text-sm italic">
                          ‚Äî {e.description}
                        </span>
                      )}
                    </div>
                  </li>
                ))}
              </ul>
            </div>
          ))
        }
      </div>

      <!-- Empty state message if no entries -->
      {
        groups.length === 0 && (
          <div class="py-12 text-center">
            <p class="text-muted-foreground">
              No CTF entries yet. Add some to the entries array!
            </p>
          </div>
        )
      }
    </div>
  </section>
</Layout>
