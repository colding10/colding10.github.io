---
import { ScrollArea } from '@/components/ui/scroll-area'
import type { TOCSection } from '@/lib/data-utils'
import { getParentId, isSubpost } from '@/lib/data-utils'
import { cn, getHeadingMargin } from '@/lib/utils'

type Props = {
	sections: TOCSection[]
	currentPostId: string
}

const { sections, currentPostId } = Astro.props
const isCurrentSubpost = isSubpost(currentPostId)
const parentId = isCurrentSubpost ? getParentId(currentPostId) : currentPostId
---

{
	sections.length > 0 && (
		<div
			id="toc-sidebar-container"
			class="sticky top-20 col-start-1 row-span-1 mr-8 ml-auto hidden h-[calc(100vh-5rem)] max-w-md xl:block"
		>
			<ScrollArea
				client:load
				className="flex max-h-[calc(100vh-8rem)] flex-col overflow-y-auto"
				type="hover"
				data-toc-scroll-area
			>
				<div class="flex flex-col gap-2 px-4">
					<span class="text-lg font-medium">Table of Contents</span>
					{sections.map((section, index) => {
						const isFirstSubpost =
							section.type === 'subpost' &&
							(index === 0 ||
								sections[index - 1].type === 'parent')

						return (
							<>
								{isFirstSubpost && (
									<div class="mt-2 flex items-center gap-2">
										<div class="bg-border h-px flex-1" />
										<span class="text-muted-foreground text-xs font-medium">
											Subposts
										</span>
										<div class="bg-border h-px flex-1" />
									</div>
								)}

								{section.type === 'parent' ? (
									<ul class="flex list-none flex-col gap-y-2">
										{section.headings.map((heading) => (
											<li
												class={cn(
													'text-sm',
													getHeadingMargin(
														heading.depth,
													),
													isCurrentSubpost
														? 'text-foreground/40'
														: 'text-foreground/60',
												)}
											>
												<a
													href={
														isCurrentSubpost
															? `/blog/${parentId}#${heading.slug}`
															: `#${heading.slug}`
													}
													class="marker:text-foreground/30 -mx-2 list-none rounded px-2 py-1 underline decoration-transparent underline-offset-[3px] transition-all duration-200 hover:decoration-inherit"
													data-heading-link={
														heading.slug
													}
												>
													{heading.text}
												</a>
											</li>
										))}
									</ul>
								) : (
									<div
										class={cn(
											'border p-2',
											section.subpostId === currentPostId
												? 'bg-muted/50'
												: '',
										)}
									>
										<ul class="flex list-none flex-col gap-y-2">
											<li
												class={cn(
													'text-xs font-medium',
													section.subpostId ===
														currentPostId
														? 'text-foreground'
														: 'text-foreground/60',
												)}
											>
												<a
													href={
														section.subpostId ===
														currentPostId
															? '#'
															: `/blog/${section.subpostId}`
													}
													class="marker:text-foreground/30 -mx-2 list-none rounded px-2 py-1 underline decoration-transparent underline-offset-[3px] transition-all duration-200 hover:decoration-inherit"
													data-heading-link={
														section.subpostId ===
														currentPostId
															? 'top'
															: `${section.subpostId}-top`
													}
												>
													{section.title}
												</a>
											</li>
											{section.headings.map((heading) => (
												<li
													class={cn(
														'text-xs',
														getHeadingMargin(
															heading.depth,
														),
														section.subpostId ===
															currentPostId
															? 'text-foreground/60'
															: 'text-foreground/30',
													)}
												>
													<a
														href={
															section.subpostId ===
															currentPostId
																? `#${heading.slug}`
																: `/blog/${section.subpostId}#${heading.slug}`
														}
														class="marker:text-foreground/30 hover:text-foreground/60 -mx-2 list-none rounded px-2 py-1 underline decoration-transparent underline-offset-[3px] transition-all duration-200 hover:decoration-inherit"
														data-heading-link={
															section.subpostId ===
															currentPostId
																? heading.slug
																: `${section.subpostId}-${heading.slug}`
														}
													>
														{heading.text}
													</a>
												</li>
											))}
										</ul>
									</div>
								)}
							</>
						)
					})}
				</div>
			</ScrollArea>
		</div>
	)
}

<script>
	import {
		buildHeadingRegions,
		getVisibleHeadingIds,
		getProseHeadings,
		updateScrollMask,
		scrollToCenter,
		createLifecycleController,
		type HeadingRegion,
	} from '@/scripts/toc-utils'

	const HEADER_OFFSET = 80
	const CONTAINER_ID = 'toc-sidebar-container'

	interface TOCState {
		links: NodeListOf<Element>
		activeIds: string[]
		headings: HTMLElement[]
		regions: HeadingRegion[]
		scrollArea: HTMLElement | null
		tocScrollArea: HTMLElement | null
	}

	const state: TOCState = {
		links: document.querySelectorAll('[data-heading-link]'),
		activeIds: [],
		headings: [],
		regions: [],
		scrollArea: null,
		tocScrollArea: null,
	}

	function resetState() {
		const container = document.getElementById(CONTAINER_ID)
		state.links = document.querySelectorAll(
			`#${CONTAINER_ID} [data-heading-link]`,
		)
		state.activeIds = []
		state.headings = []
		state.regions = []
		state.scrollArea =
			container?.querySelector('[data-radix-scroll-area-viewport]') || null
		state.tocScrollArea =
			container?.querySelector('[data-toc-scroll-area]') || null
	}

	function updateMask() {
		if (!state.scrollArea || !state.tocScrollArea) return
		updateScrollMask(
			state.scrollArea,
			state.tocScrollArea,
			'mask-t-from-90%',
			'mask-b-from-90%',
		)
	}

	function updateLinks(headingIds: string[]) {
		state.links.forEach((link) => {
			link.classList.remove(
				'text-foreground',
				'bg-accent',
				'border-l-2',
				'border-primary',
				'pl-2',
			)
		})

		headingIds.forEach((id) => {
			if (id) {
				const activeLink = document.querySelector(
					`#${CONTAINER_ID} [data-heading-link="${id}"]`,
				)
				if (activeLink) {
					activeLink.classList.add(
						'text-foreground',
						'bg-accent',
						'border-l-2',
						'border-primary',
						'pl-2',
					)
				}
			}
		})

		if (state.scrollArea && headingIds.length > 0) {
			const activeLink = document.querySelector(
				`#${CONTAINER_ID} [data-heading-link="${headingIds[0]}"]`,
			)
			if (activeLink) {
				scrollToCenter(state.scrollArea, activeLink)
			}
		}
	}

	function handleScroll() {
		const newActiveIds = getVisibleHeadingIds(
			state.headings,
			state.regions,
			HEADER_OFFSET,
		)

		if (JSON.stringify(newActiveIds) !== JSON.stringify(state.activeIds)) {
			state.activeIds = newActiveIds
			updateLinks(state.activeIds)
		}
	}

	function handleResize() {
		state.headings = getProseHeadings()
		state.regions = buildHeadingRegions(state.headings)

		const newActiveIds = getVisibleHeadingIds(
			state.headings,
			state.regions,
			HEADER_OFFSET,
		)

		if (JSON.stringify(newActiveIds) !== JSON.stringify(state.activeIds)) {
			state.activeIds = newActiveIds
			updateLinks(state.activeIds)
		}

		updateMask()
	}

	function init() {
		resetState()
		state.headings = getProseHeadings()
		state.regions = buildHeadingRegions(state.headings)

		if (state.headings.length === 0) {
			updateLinks([])
			return
		}

		handleScroll()
		setTimeout(updateMask, 100)

		const options = { passive: true }
		window.addEventListener('scroll', handleScroll, options)
		window.addEventListener('resize', handleResize, options)
		state.scrollArea?.addEventListener('scroll', updateMask, options)
	}

	function cleanup() {
		window.removeEventListener('scroll', handleScroll)
		window.removeEventListener('resize', handleResize)
		state.scrollArea?.removeEventListener('scroll', updateMask)
		state.activeIds = []
		state.headings = []
		state.regions = []
		state.scrollArea = null
		state.tocScrollArea = null
	}

	createLifecycleController(init, cleanup)
</script>
