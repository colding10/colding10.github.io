---
import { ScrollArea } from '@/components/ui/scroll-area'
import { cn, getHeadingMargin } from '@/lib/utils'
import type { MarkdownHeading } from 'astro'
import { Icon } from 'astro-icon/components'

type Props = {
	headings: MarkdownHeading[]
}

const { headings } = Astro.props
---

{
	headings && headings.length > 0 && (
		<div id="mobile-toc-container" class="w-full xl:hidden">
			<details class="group">
				<summary class="flex w-full cursor-pointer items-center justify-between">
					<div class="mx-auto flex w-full max-w-3xl items-center px-4 py-3">
						<div class="relative mr-2 size-4">
							<svg class="h-4 w-4" viewBox="0 0 24 24">
								<circle
									class="text-primary/20"
									cx="12"
									cy="12"
									r="10"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
								/>
								<circle
									id="mobile-toc-progress-circle"
									class="text-primary"
									cx="12"
									cy="12"
									r="10"
									fill="none"
									stroke="currentColor"
									stroke-width="2"
									stroke-dasharray="62.83"
									stroke-dashoffset="62.83"
									transform="rotate(-90 12 12)"
								/>
							</svg>
						</div>
						<span
							id="mobile-toc-current-section"
							class="text-muted-foreground flex-grow truncate text-sm"
						>
							Overview
						</span>
						<span class="text-muted-foreground ml-2">
							<Icon
								name="lucide:chevron-down"
								class="h-4 w-4 transition-transform duration-200 group-open:rotate-180"
							/>
						</span>
					</div>
				</summary>

				<ScrollArea
					client:load
					className="mx-auto max-w-3xl"
					data-toc-header-scroll
				>
					<div class="max-h-[30vh]">
						<ul
							class="flex list-none flex-col gap-y-2 px-4 pb-4"
							id="mobile-table-of-contents"
						>
							{headings.map((heading) => (
								<li
									class={cn(
										'px-4 text-sm',
										getHeadingMargin(heading.depth),
										'text-foreground/60',
									)}
								>
									<a
										href={`#${heading.slug}`}
										class="mobile-toc-item underline decoration-transparent underline-offset-[3px] transition-colors duration-200 hover:decoration-inherit"
										data-heading-id={heading.slug}
									>
										{heading.text}
									</a>
								</li>
							))}
						</ul>
					</div>
				</ScrollArea>
			</details>
		</div>
	)
}

<script>
	import {
		buildHeadingRegions,
		getVisibleHeadingIds,
		getProseHeadings,
		updateScrollMask,
		scrollToCenter,
		createLifecycleController,
		type HeadingRegion,
	} from '@/scripts/toc-utils'

	const INITIAL_OVERVIEW_TEXT = 'Overview'
	const HEADER_OFFSET = 102 + 36
	const PROGRESS_CIRCLE_RADIUS = 10
	const PROGRESS_CIRCLE_CIRCUMFERENCE = 2 * Math.PI * PROGRESS_CIRCLE_RADIUS
	const CONTAINER_ID = 'mobile-toc-container'

	interface MobileTOCState {
		progressCircle: HTMLElement | null
		currentSectionText: HTMLElement | null
		detailsElement: HTMLDetailsElement | null
		listElement: HTMLElement | null
		scrollArea: HTMLElement | null
		tocHeaderScroll: HTMLElement | null
		headings: HTMLElement[]
		regions: HeadingRegion[]
		activeIds: string[]
	}

	const state: MobileTOCState = {
		progressCircle: null,
		currentSectionText: null,
		detailsElement: null,
		listElement: null,
		scrollArea: null,
		tocHeaderScroll: null,
		headings: [],
		regions: [],
		activeIds: [],
	}

	function resetState() {
		const container = document.getElementById(CONTAINER_ID)
		state.progressCircle = document.getElementById(
			'mobile-toc-progress-circle',
		)
		state.currentSectionText = document.getElementById(
			'mobile-toc-current-section',
		)
		state.detailsElement = document.querySelector(
			`#${CONTAINER_ID} details`,
		)
		state.listElement = document.getElementById('mobile-table-of-contents')
		state.scrollArea =
			container?.querySelector('[data-radix-scroll-area-viewport]') || null
		state.tocHeaderScroll =
			container?.querySelector('[data-toc-header-scroll]') || null
		state.headings = []
		state.regions = []
		state.activeIds = []

		if (state.progressCircle) {
			state.progressCircle.style.strokeDasharray =
				PROGRESS_CIRCLE_CIRCUMFERENCE.toString()
			state.progressCircle.style.strokeDashoffset =
				PROGRESS_CIRCLE_CIRCUMFERENCE.toString()
		}
	}

	function updateMask() {
		if (!state.scrollArea || !state.tocHeaderScroll) return
		updateScrollMask(
			state.scrollArea,
			state.tocHeaderScroll,
			'mask-t-from-80%',
			'mask-b-from-80%',
		)
	}

	function updateProgress() {
		if (!state.progressCircle) return

		const scrollableDistance =
			document.documentElement.scrollHeight - window.innerHeight
		const scrollProgress =
			scrollableDistance > 0
				? Math.min(Math.max(window.scrollY / scrollableDistance, 0), 1)
				: 0

		state.progressCircle.style.strokeDashoffset = (
			PROGRESS_CIRCLE_CIRCUMFERENCE *
			(1 - scrollProgress)
		).toString()
	}

	function updateCurrentSectionText(headingIds: string[]) {
		if (!state.currentSectionText) return

		let textToShow = INITIAL_OVERVIEW_TEXT

		if (headingIds.length > 0) {
			const activeTexts = state.headings
				.filter(
					(heading) =>
						headingIds.includes(heading.id) && heading.textContent,
				)
				.map((heading) => heading.textContent!.trim())

			if (activeTexts.length > 0) {
				textToShow = activeTexts.join(', ')
			}
		}

		state.currentSectionText.textContent = textToShow
	}

	function updateLinks(headingIds: string[]) {
		if (!state.listElement || !state.currentSectionText) return

		state.listElement.querySelectorAll('.mobile-toc-item').forEach((item) => {
			const tocItem = item as HTMLElement
			const headingId = tocItem.dataset.headingId
			if (headingId && headingIds.includes(headingId)) {
				tocItem.classList.add('text-foreground')
			} else {
				tocItem.classList.remove('text-foreground')
			}
		})

		if (headingIds.length > 0 && state.scrollArea) {
			const activeItem = state.listElement.querySelector(
				`[data-heading-id="${headingIds[0]}"]`,
			)
			if (activeItem) {
				scrollToCenter(state.scrollArea, activeItem)
			}
		}

		updateCurrentSectionText(headingIds)
	}

	function setupInteraction() {
		if (!state.listElement) return

		state.listElement.querySelectorAll('.mobile-toc-item').forEach((item) => {
			item.addEventListener('click', () => {
				if (state.detailsElement) state.detailsElement.open = false
			})
		})

		if (state.scrollArea) {
			state.scrollArea.addEventListener('scroll', updateMask, {
				passive: true,
			})
		}

		if (state.detailsElement) {
			state.detailsElement.addEventListener('toggle', () => {
				if (state.detailsElement?.open) {
					setTimeout(updateMask, 100)
				}
			})
		}
	}

	function handleScroll() {
		const newActiveIds = getVisibleHeadingIds(
			state.headings,
			state.regions,
			HEADER_OFFSET,
		)

		if (JSON.stringify(newActiveIds) !== JSON.stringify(state.activeIds)) {
			state.activeIds = newActiveIds
			updateLinks(state.activeIds)
		}

		updateProgress()
	}

	function handleResize() {
		state.headings = getProseHeadings()
		state.regions = buildHeadingRegions(state.headings)

		const newActiveIds = getVisibleHeadingIds(
			state.headings,
			state.regions,
			HEADER_OFFSET,
		)

		if (JSON.stringify(newActiveIds) !== JSON.stringify(state.activeIds)) {
			state.activeIds = newActiveIds
			updateLinks(state.activeIds)
		}

		updateProgress()
	}

	function init() {
		resetState()
		state.headings = getProseHeadings()
		state.regions = buildHeadingRegions(state.headings)

		if (!state.currentSectionText) return

		if (state.headings.length === 0) {
			state.currentSectionText.textContent = INITIAL_OVERVIEW_TEXT
			window.addEventListener('scroll', updateProgress, { passive: true })
			updateProgress()
			return
		}

		state.activeIds = getVisibleHeadingIds(
			state.headings,
			state.regions,
			HEADER_OFFSET,
		)
		updateLinks(state.activeIds)
		updateProgress()

		setupInteraction()
		window.addEventListener('scroll', handleScroll, { passive: true })
		window.addEventListener('resize', handleResize, { passive: true })
	}

	function cleanup() {
		window.removeEventListener('scroll', handleScroll)
		window.removeEventListener('scroll', updateProgress)
		window.removeEventListener('resize', handleResize)
		state.activeIds = []
		state.headings = []
		state.regions = []
	}

	createLifecycleController(init, cleanup)
</script>
